{"version":3,"file":"transaction.js","sourceRoot":"","sources":["../../../src/transaction.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCurrentHub, Hub } from '@sentry/hub';\nimport {\n  Event,\n  Measurements,\n  Transaction as TransactionInterface,\n  TransactionContext,\n  TransactionMetadata,\n} from '@sentry/types';\nimport { dropUndefinedKeys, isInstanceOf, logger } from '@sentry/utils';\n\nimport { IS_DEBUG_BUILD } from './flags';\nimport { Span as SpanClass, SpanRecorder } from './span';\n\n/** JSDoc */\nexport class Transaction extends SpanClass implements TransactionInterface {\n  public name: string;\n\n  public metadata: TransactionMetadata;\n\n  private _measurements: Measurements = {};\n\n  /**\n   * The reference to the current hub.\n   */\n  private readonly _hub: Hub = getCurrentHub() as unknown as Hub;\n\n  private _trimEnd?: boolean;\n\n  /**\n   * This constructor should never be called manually. Those instrumenting tracing should use\n   * `Sentry.startTransaction()`, and internal methods should use `hub.startTransaction()`.\n   * @internal\n   * @hideconstructor\n   * @hidden\n   */\n  public constructor(transactionContext: TransactionContext, hub?: Hub) {\n    super(transactionContext);\n\n    if (isInstanceOf(hub, Hub)) {\n      this._hub = hub as Hub;\n    }\n\n    this.name = transactionContext.name || '';\n\n    this.metadata = transactionContext.metadata || {};\n    this._trimEnd = transactionContext.trimEnd;\n\n    // this is because transactions are also spans, and spans have a transaction pointer\n    this.transaction = this;\n  }\n\n  /**\n   * JSDoc\n   */\n  public setName(name: string): void {\n    this.name = name;\n  }\n\n  /**\n   * Attaches SpanRecorder to the span itself\n   * @param maxlen maximum number of spans that can be recorded\n   */\n  public initSpanRecorder(maxlen: number = 1000): void {\n    if (!this.spanRecorder) {\n      this.spanRecorder = new SpanRecorder(maxlen);\n    }\n    this.spanRecorder.add(this);\n  }\n\n  /**\n   * Set observed measurements for this transaction.\n   * @hidden\n   */\n  public setMeasurements(measurements: Measurements): void {\n    this._measurements = { ...measurements };\n  }\n\n  /**\n   * Set metadata for this transaction.\n   * @hidden\n   */\n  public setMetadata(newMetadata: TransactionMetadata): void {\n    this.metadata = { ...this.metadata, ...newMetadata };\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public finish(endTimestamp?: number): string | undefined {\n    // This transaction is already finished, so we should not flush it again.\n    if (this.endTimestamp !== undefined) {\n      return undefined;\n    }\n\n    if (!this.name) {\n      IS_DEBUG_BUILD && logger.warn('Transaction has no name, falling back to `<unlabeled transaction>`.');\n      this.name = '<unlabeled transaction>';\n    }\n\n    // just sets the end timestamp\n    super.finish(endTimestamp);\n\n    if (this.sampled !== true) {\n      // At this point if `sampled !== true` we want to discard the transaction.\n      IS_DEBUG_BUILD && logger.log('[Tracing] Discarding transaction because its trace was not chosen to be sampled.');\n\n      const client = this._hub.getClient();\n      const transport = client && client.getTransport && client.getTransport();\n      if (transport && transport.recordLostEvent) {\n        transport.recordLostEvent('sample_rate', 'transaction');\n      }\n      return undefined;\n    }\n\n    const finishedSpans = this.spanRecorder ? this.spanRecorder.spans.filter(s => s !== this && s.endTimestamp) : [];\n\n    if (this._trimEnd && finishedSpans.length > 0) {\n      this.endTimestamp = finishedSpans.reduce((prev: SpanClass, current: SpanClass) => {\n        if (prev.endTimestamp && current.endTimestamp) {\n          return prev.endTimestamp > current.endTimestamp ? prev : current;\n        }\n        return prev;\n      }).endTimestamp;\n    }\n\n    const transaction: Event = {\n      contexts: {\n        trace: this.getTraceContext(),\n      },\n      spans: finishedSpans,\n      start_timestamp: this.startTimestamp,\n      tags: this.tags,\n      timestamp: this.endTimestamp,\n      transaction: this.name,\n      type: 'transaction',\n      sdkProcessingMetadata: this.metadata,\n    };\n\n    const hasMeasurements = Object.keys(this._measurements).length > 0;\n\n    if (hasMeasurements) {\n      IS_DEBUG_BUILD &&\n        logger.log(\n          '[Measurements] Adding measurements to transaction',\n          JSON.stringify(this._measurements, undefined, 2),\n        );\n      transaction.measurements = this._measurements;\n    }\n\n    IS_DEBUG_BUILD && logger.log(`[Tracing] Finishing ${this.op} transaction: ${this.name}.`);\n\n    return this._hub.captureEvent(transaction);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public toContext(): TransactionContext {\n    const spanContext = super.toContext();\n\n    return dropUndefinedKeys({\n      ...spanContext,\n      name: this.name,\n      trimEnd: this._trimEnd,\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public updateWithContext(transactionContext: TransactionContext): this {\n    super.updateWithContext(transactionContext);\n\n    this.name = transactionContext.name ?? '';\n\n    this._trimEnd = transactionContext.trimEnd;\n\n    return this;\n  }\n}\n"]}